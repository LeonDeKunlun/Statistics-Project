---
title: "Untitled"
format: pdf
editor_options:
  chunk_output_type: console
---

```{r}
# load packages
library(tidyverse)
library(jsonlite)
```

```{r}
# set locale
sys_locale <- "en_GB.utf8"
Sys.setlocale(locale = sys_locale)
weekends <- lubridate::make_date(day = 3:4) %>% lubridate::wday(label = TRUE)

# set global theme
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 12))
```

```{r}
# read the data
gas_demand <-
  utils::read.csv(
    file = "Scotland_Gas_Demand_and_CWV_01-01-2021_31-12-2024.csv",
    check.names = FALSE) %>%
  dplyr::rename(`Gas Day` = `Applicable For`) %>%
  dplyr::mutate(
    dplyr::across(
      `Gas Day`,
      . %>% as.Date(format = "%d/%m/%Y")),
    dplyr::across(
      `Data Item`,
      . %>% dplyr::case_match(
        "Demand Actual, LDZ (SC), D+6" ~ "Gas Demand",
        "Composite Weather Variable, Actual, LDZ(SC), D+1" ~
          "Composite Weather Variable")))
```

```{r}
# fetch public holiday data
holidays <-
  jsonlite::fromJSON(
    txt = "https://www.gov.uk/bank-holidays.json"
  )$scotland$events$date %>%
  as.Date(format = "%Y-%m-%d") %>%
  as.data.frame.vector(nm = "Holiday")
```

```{r}
quality_colour <- c("grey", "A" = "red", "L" = "orange")
```

```{r}
# summaries of Gas Demand

gas_demand %>%
  dplyr::filter(`Data Item` == "Gas Demand") %>%
  ggplot2::ggplot(mapping = ggplot2::aes(
    x = `Gas Day`,
    y = Value,
    colour = `Quality Indicator`)) +
  ggplot2::scale_colour_manual(values = quality_colour) +
  ggplot2::geom_point(size = 1) +
  ggplot2::labs(
    y = "Gas Demand",
    title = "Gas Demand vs Gas Day")

gas_demand %>%
  dplyr::filter(`Data Item` == "Gas Demand") %>%
  ggplot2::ggplot(mapping = ggplot2::aes(
    x = `Quality Indicator`,
    y = Value,
    colour = `Quality Indicator`)) +
  ggplot2::scale_colour_manual(values = quality_colour) +
  ggplot2::geom_boxplot(
    outliers = FALSE,
    varwidth = TRUE) +
  ggplot2::geom_violin(
    mapping = ggplot2::aes(
      fill = ggplot2::after_scale(scales::alpha(colour, 0.38))),
    data = . %>% dplyr::filter(`Quality Indicator` == ""),
    show.legend = FALSE) +
  ggplot2::geom_dotplot(
    mapping = ggplot2::aes(
      fill = ggplot2::after_scale(scales::alpha(colour, 0.38))),
    data = . %>% dplyr::filter(`Quality Indicator` != ""),
    binaxis = "y",
    stackdir = "center",
    dotsize = 0.62)
```

```{r}
# summaries of Composite Weather Variable

gas_demand %>%
  dplyr::filter(`Data Item` == "Composite Weather Variable") %>%
  ggplot2::ggplot(mapping = ggplot2::aes(
    x = `Gas Day`,
    y = Value,
    colour = `Quality Indicator`)) +
  ggplot2::scale_colour_manual(values = quality_colour) +
  ggplot2::geom_point(size = 1) +
  ggplot2::labs(
    y = "Composite Weather Variable",
    title = "Composite Weather Variable vs Gas Day")
```

```{r}
gas_demand_wide <-
  gas_demand %>%
  # remove outliers
  dplyr::mutate(dplyr::across(
    Value,
    \(.) dplyr::if_else(
      `Data Item` == "Gas Demand" & `Quality Indicator` != "",
      NA, .))) %>%
  # transform the data frame
  tidyr::pivot_wider(
    id_cols = `Gas Day`,
    names_from = `Data Item`,
    values_from = Value) %>%
  # add day of the week
  dplyr::mutate(
    `Day of the Week` = `Gas Day` %>% lubridate::wday(label = TRUE)) %>%
  # add public holiday data
  dplyr::left_join(
    holidays,
    by = dplyr::join_by(`Gas Day` == Holiday),
    keep = TRUE,
    relationship = "one-to-one") %>%
  dplyr::mutate(dplyr::across(
    Holiday,
    \(.) !is.na(.) | `Day of the Week` %in% weekends))
```

```{r}
gas_demand_wide %>%
  ggplot2::ggplot(mapping = ggplot2::aes(
    x = `Composite Weather Variable`,
    y = `Gas Demand`)) +
  ggplot2::geom_point() +
  ggplot2::labs(title = "Demand Actual, LDZ (SC), D+6")
```

```{r}
gas_demand_wide %>%
  ggplot2::ggplot(mapping = ggplot2::aes(
    x = `Composite Weather Variable`,
    y = `Gas Demand`,
    colour = Holiday)) +
  ggplot2::geom_point() +
  ggplot2::labs(title = "Demand Actual, LDZ (SC), D+6")
```



